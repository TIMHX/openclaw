- name: Select Xcode 16.2
        run: |
          sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
          # 打印版本确保切换成功
          xcodebuild -version
          swift --version

      - name: Install Dependencies
        run: pnpm install

      - name: Generate Xcode Project
        run: |
          brew install xcodegen
          cd apps/ios
          cp LocalSigning.xcconfig.example LocalSigning.xcconfig
          # 强制重新生成，确保 SPM 依赖刷新
          xcodegen generate

      - name: Build Archive
        # 通过环境变量 DEVELOPER_DIR 强制 xcodebuild 使用指定版本
        env:
          DEVELOPER_DIR: /Applications/Xcode_16.2.app/Contents/Developer
        run: |
          # 核心修复：增加 -clonedSourcePackagesDirPath 来隔离包缓存
          xcodebuild archive \
            -project apps/ios/OpenClaw.xcodeproj \
            -scheme OpenClaw \
            -configuration Debug \
            -sdk iphoneos \
            -archivePath ./build/OpenClaw.xcarchive \
            -clonedSourcePackagesDirPath ./build/spm \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO
